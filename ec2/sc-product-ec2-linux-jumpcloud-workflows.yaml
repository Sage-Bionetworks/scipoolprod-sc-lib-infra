AWSTemplateFormatVersion: '2010-09-09'
Description: 'Workflows Linux EC2 ServiceCatalog product with Jumpcloud integration.'
Parameters:
  PortfolioProvider:
    Type: String
    Description: Owner and Distributor Name
    Default: IT Services
  RepoRootURL:
    Type: String
    Description: Root url for the repo containing the product templates.
  StackDatetime:
    Type: String
    Description: Last updated date and time of portfolio
    Default: ''
  PortfolioId:
    Type: String
    Description: ID of the portfolio that will contain this product
  ProductName:
    Type: String
    Description: Name of the product that will be visible to the end user
    Default: 'Workflows Linux EC2 Instance with Jumpcloud Integration'
Resources:
  ScEc2LinuxJumpcloudWorkflowsProduct:
    Type: AWS::ServiceCatalog::CloudFormationProduct
    Metadata:
      cfn-lint:
        config:
          ignore_checks:
            - E3002
    Properties:
      Name: !Ref ProductName
      Description: This product builds one Linux EC2 instance using an Ubuntu AMI
        with workflows software installed. Maintained by Sage Bionetworks. 
      Owner: !Ref 'PortfolioProvider'
      Distributor: !Ref 'PortfolioProvider'
      ProvisioningArtifactParameters:
        - Description: !Sub 'Baseline version. Last portfolio update occurred at ${StackDatetime}.'
          Info:
            LoadTemplateFromURL: !Sub '${RepoRootURL}ec2/sc-ec2-linux-jumpcloud-workflows-v1.0.0.yaml'
          Name: v1.0.0
      'Fn::Transform':
        Name: 'AWS::Include'
        Parameters:
          Location : "s3://cfn-snippets-bucket-cloudformationsnippetsbucket-elu83sv8ocdz/scipoolprod-sc-lib-infra/support.yaml"
  Associateec2linux:
    Type: AWS::ServiceCatalog::PortfolioProductAssociation
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref 'ScEc2LinuxJumpcloudWorkflowsProduct'
  constraintec2linux:
    Type: AWS::ServiceCatalog::LaunchRoleConstraint
    DependsOn: Associateec2linux
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref 'ScEc2LinuxJumpcloudWorkflowsProduct'
      RoleArn: !ImportValue
        'Fn::Sub': '${AWS::Region}-sc-ec2vpc-launchrole-LaunchRoleArn'
  AssociateRestartEC2InstanceAction:
    Type: Custom::ScActionsProvider
    Properties:
      ServiceToken: !ImportValue
        'Fn::Sub': '${AWS::Region}-cfn-cr-sc-actions-provider-AssociateFunctionArn'
      ServiceActionId: !ImportValue
        'Fn::Sub': '${AWS::Region}-sc-ec2-actions-RestartEC2InstanceActionId'
      ProductId: !Ref ScEc2LinuxJumpcloudWorkflowsProduct
      ProvisioningArtifactId: !GetAtt ScEc2LinuxJumpcloudWorkflowsProduct.ProvisioningArtifactIds
  AssociateStartEC2InstanceAction:
    Type: Custom::ScActionsProvider
    Properties:
      ServiceToken: !ImportValue
        'Fn::Sub': '${AWS::Region}-cfn-cr-sc-actions-provider-AssociateFunctionArn'
      ServiceActionId: !ImportValue
        'Fn::Sub': '${AWS::Region}-sc-ec2-actions-StartEC2InstanceActionId'
      ProductId: !Ref ScEc2LinuxJumpcloudWorkflowsProduct
      ProvisioningArtifactId: !GetAtt ScEc2LinuxJumpcloudWorkflowsProduct.ProvisioningArtifactIds
  AssociateStopEC2InstanceAction:
    Type: Custom::ScActionsProvider
    Properties:
      ServiceToken: !ImportValue
        'Fn::Sub': '${AWS::Region}-cfn-cr-sc-actions-provider-AssociateFunctionArn'
      ServiceActionId: !ImportValue
        'Fn::Sub': '${AWS::Region}-sc-ec2-actions-StopEC2InstanceActionId'
      ProductId: !Ref ScEc2LinuxJumpcloudWorkflowsProduct
      ProvisioningArtifactId: !GetAtt ScEc2LinuxJumpcloudWorkflowsProduct.ProvisioningArtifactIds
Outputs:
  ProductId:
    Value: !Ref 'ScEc2LinuxJumpcloudWorkflowsProduct'
    Export:
      Name: !Sub '${AWS::Region}-${AWS::StackName}-ProductId'
